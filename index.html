<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Digital Madrasah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } @page { size: landscape; margin: 1cm; } }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAlXDVBSJryVlGwtZWYL_BNnh6-7R-SbXk",
            authDomain: "jurnal-guru-f06df.firebaseapp.com",
            projectId: "jurnal-guru-f06df",
            storageBucket: "jurnal-guru-f06df.firebasestorage.app",
            messagingSenderId: "782875410114",
            appId: "1:782875410114:web:67ad0f9c79b35fcc16055b",
            measurementId: "G-FTFKJGVFM1"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        const appId = 'presensi-madrasah-pro';

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('input-siswa');
            const [classes, setClasses] = useState([]); 
            const [attendanceRecords, setAttendanceRecords] = useState([]); 
            const [loading, setLoading] = useState(true);
            
            // UI States
            const [newClassName, setNewClassName] = useState('');
            const [newStudentName, setNewStudentName] = useState('');
            const [selectedClassId, setSelectedClassId] = useState('');
            const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
            const [rekapMonth, setRekapMonth] = useState(new Date().getMonth());
            const [rekapYear, setRekapYear] = useState(new Date().getFullYear());

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const years = Array.from({length: 5}, (_, i) => new Date().getFullYear() - 2 + i);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    setClasses([]);
                    setAttendanceRecords([]);
                    return;
                }

                const unsubClasses = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('classes')
                    .onSnapshot((snapshot) => {
                        setClasses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, (err) => console.error(err));

                const unsubAttend = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('attendance')
                    .onSnapshot((snapshot) => {
                        setAttendanceRecords(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, (err) => console.error(err));

                return () => { unsubClasses(); unsubAttend(); };
            }, [user]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [activeTab, user, loading, selectedClassId]);

            const handleLogin = async () => {
                try { await auth.signInWithPopup(googleProvider); } 
                catch (err) { console.error("Login failed", err); }
            };

            const handleLogout = () => auth.signOut();

            const addClass = async () => {
                if (!newClassName.trim() || !user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('classes').add({
                    name: newClassName, students: [], createdAt: new Date().toISOString()
                });
                setNewClassName('');
            };

            const addStudent = async (classId) => {
                if (!newStudentName.trim() || !user) return;
                const target = classes.find(c => c.id === classId);
                const updated = [...target.students, { id: Date.now().toString(), name: newStudentName }].sort((a,b) => a.name.localeCompare(b.name));
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('classes').doc(classId).update({ students: updated });
                setNewStudentName('');
            };

            const deleteClass = async (id) => {
                if (!user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('classes').doc(id).delete();
            };

            const saveAttendance = async (classId, date, status) => {
                if (!user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('attendance').doc(`${classId}-${date}`).set({
                    date, classId, status, updatedAt: new Date().toISOString()
                });
            };

            const exportToExcel = () => {
                const currentClass = classes.find(c => c.id === selectedClassId);
                if (!currentClass) return;

                const data = currentClass.students.map(s => {
                    let sCount = 0, iCount = 0, aCount = 0, hCount = 0;
                    attendanceRecords
                        .filter(r => r.classId === selectedClassId && new Date(r.date).getMonth() === parseInt(rekapMonth) && new Date(r.date).getFullYear() === parseInt(rekapYear))
                        .forEach(r => {
                            const stat = r.status?.[s.id];
                            if(stat === 'S') sCount++; else if(stat === 'I') iCount++; else if(stat === 'A') aCount++; else hCount++;
                        });
                    
                    return {
                        "Nama Siswa": s.name,
                        "Sakit": sCount,
                        "Izin": iCount,
                        "Alfa": aCount,
                        "Hadir": hCount
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap Presensi");
                XLSX.writeFile(wb, `Rekap_${currentClass.name}_${months[rekapMonth]}_${rekapYear}.xlsx`);
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p className="text-slate-500 font-bold animate-pulse">Menghubungkan ke Cloud...</p>
                    </div>
                </div>
            );

            if (!user) return (
                <div className="h-screen flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white p-10 rounded-3xl shadow-xl text-center border border-slate-100">
                        <div className="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-blue-600">
                            <i data-lucide="clipboard-check" style={{width: 40, height: 40}}></i>
                        </div>
                        <h1 className="text-3xl font-black mb-2 text-slate-800">Presensi Digital</h1>
                        <p className="text-slate-500 mb-8 text-sm leading-relaxed">Kelola data kehadiran siswa dengan mudah. Seluruh data tersimpan aman di akun Google Anda.</p>
                        <button onClick={handleLogin} className="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 p-4 rounded-2xl font-bold hover:bg-slate-50 transition-all shadow-sm active:scale-95">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa_google_main_logo.svg" className="w-6" alt="Google" />
                            Masuk dengan Akun Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 print:p-0">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-8 flex flex-col md:flex-row items-center justify-between gap-4 no-print bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 p-3 rounded-2xl text-white shadow-lg shadow-blue-200"><i data-lucide="check-square"></i></div>
                                <div>
                                    <h1 className="text-xl font-black uppercase tracking-tight text-slate-800 leading-none mb-1">Presensi Digital</h1>
                                    <p className="text-xs text-slate-400 font-bold tracking-wide">{user.email}</p>
                                </div>
                            </div>
                            <div className="flex bg-slate-50 p-1.5 rounded-2xl border items-center">
                                <button onClick={() => setActiveTab('input-siswa')} className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all ${activeTab === 'input-siswa' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>SISWA</button>
                                <button onClick={() => setActiveTab('input-hadir')} className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all ${activeTab === 'input-hadir' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>ABSEN</button>
                                <button onClick={() => setActiveTab('rekap')} className={`px-5 py-2.5 rounded-xl text-xs font-black transition-all ${activeTab === 'rekap' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>REKAP</button>
                                <button onClick={handleLogout} className="ml-2 px-3 text-slate-300 hover:text-red-500 transition-colors" title="Logout"><i data-lucide="log-out" style={{width:20}}></i></button>
                            </div>
                        </header>

                        {activeTab === 'input-siswa' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                                    <h3 className="font-black mb-6 flex items-center gap-3 text-slate-700 uppercase tracking-widest text-sm"><i data-lucide="plus-circle" className="text-blue-600" style={{width:18}}></i> Tambah Kelas Baru</h3>
                                    <div className="flex gap-3">
                                        <input type="text" placeholder="Nama Kelas (Contoh: 10-IPA-1)" value={newClassName} onChange={e => setNewClassName(e.target.value)} className="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-semibold focus:ring-2 focus:ring-blue-100 transition-all" />
                                        <button onClick={addClass} className="bg-blue-600 text-white px-8 rounded-2xl font-black shadow-lg shadow-blue-100 hover:bg-blue-700 active:scale-95 transition-all">SIMPAN</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {classes.map(cls => (
                                        <div key={cls.id} className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col hover:shadow-md transition-all">
                                            <div className="bg-slate-50/50 p-5 border-b flex justify-between items-center">
                                                <span className="font-black text-slate-700 uppercase tracking-wider">{cls.name}</span>
                                                <button onClick={() => deleteClass(cls.id)} className="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" style={{width:18}}></i></button>
                                            </div>
                                            <div className="p-5 flex-1 max-h-64 overflow-y-auto custom-scrollbar">
                                                {cls.students.length === 0 ? (
                                                    <div className="text-center py-8 text-slate-300 italic text-sm">Belum ada siswa</div>
                                                ) : cls.students.map((s, i) => (
                                                    <div key={s.id} className="flex items-center gap-3 text-sm py-2 group border-b border-slate-50 last:border-0">
                                                        <span className="w-5 text-[10px] font-black text-blue-300">{i+1}</span>
                                                        <span className="flex-1 font-bold text-slate-600">{s.name}</span>
                                                        <button 
                                                            onClick={async () => {
                                                                const updated = cls.students.filter(std => std.id !== s.id);
                                                                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('classes').doc(cls.id).update({ students: updated });
                                                            }}
                                                            className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all"
                                                        >
                                                            <i data-lucide="x" style={{width:14}}></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-5 border-t bg-slate-50/20 flex gap-2">
                                                <input type="text" placeholder="Tambah Siswa..." value={selectedClassId === cls.id ? newStudentName : ''} onChange={e => {setSelectedClassId(cls.id); setNewStudentName(e.target.value)}} className="flex-1 text-xs p-3 bg-white border border-slate-100 rounded-xl outline-none font-semibold focus:ring-2 focus:ring-blue-100" onKeyPress={(e) => e.key === 'Enter' && addStudent(cls.id)}/>
                                                <button onClick={() => addStudent(cls.id)} className="bg-slate-800 text-white p-3 rounded-xl hover:bg-black transition-colors"><i data-lucide="plus" style={{width:16}}></i></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'input-hadir' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                                    <div>
                                        <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">Tanggal</label>
                                        <input type="date" value={attendanceDate} onChange={e => setAttendanceDate(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700" />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">Kelas</label>
                                        <select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700">
                                            <option value="">-- Pilih Kelas --</option>
                                            {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                                {selectedClassId && (
                                    <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                                        <div className="p-6 bg-slate-50/50 border-b flex justify-between items-center">
                                            <h3 className="font-black text-slate-700 uppercase tracking-widest text-xs">Daftar Presensi Siswa</h3>
                                            <span className="text-[10px] bg-green-100 text-green-600 px-3 py-1 rounded-full font-black">OTOMATIS SIMPAN</span>
                                        </div>
                                        <table className="w-full text-left">
                                            <thead className="bg-white text-[10px] uppercase font-black text-slate-300">
                                                <tr><th className="p-6 border-b">Nama Siswa</th><th className="p-6 border-b text-center">Status Kehadiran</th></tr>
                                            </thead>
                                            <tbody>
                                                {classes.find(c => c.id === selectedClassId)?.students.map(s => {
                                                    const record = attendanceRecords.find(r => r.id === `${selectedClassId}-${attendanceDate}`);
                                                    const status = record?.status?.[s.id];
                                                    return (
                                                        <tr key={s.id} className="border-b last:border-0 hover:bg-slate-50/30 transition-colors">
                                                            <td className="p-6 font-bold text-slate-700">{s.name}</td>
                                                            <td className="p-6">
                                                                <div className="flex justify-center gap-3">
                                                                    {['S', 'I', 'A'].map(v => (
                                                                        <button key={v} onClick={() => {
                                                                            const newStatus = {...(record?.status || {}), [s.id]: status === v ? null : v};
                                                                            saveAttendance(selectedClassId, attendanceDate, newStatus);
                                                                        }} className={`w-10 h-10 rounded-xl font-black border-2 transition-all flex items-center justify-center ${status === v ? 'bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-100 scale-110' : 'border-slate-100 text-slate-300 hover:border-blue-200'}`}>{v}</button>
                                                                    ))}
                                                                    {!status && <span className="text-[10px] text-green-500 font-black self-center ml-4 tracking-widest bg-green-50 px-3 py-1.5 rounded-lg border border-green-100">HADIR</span>}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'rekap' && (
                            <div className="space-y-4 animate-in fade-in duration-500">
                                <div className="flex flex-wrap gap-4 items-center bg-white p-6 rounded-3xl border border-slate-100 shadow-sm no-print">
                                    <div className="flex flex-wrap flex-1 gap-3">
                                        <select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none border border-transparent focus:border-blue-100 transition-all min-w-[150px]">
                                            <option value="">-- Pilih Kelas --</option>
                                            {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                        <select value={rekapMonth} onChange={e => setRekapMonth(e.target.value)} className="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none border border-transparent focus:border-blue-100 transition-all">
                                            {months.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                        </select>
                                        <select value={rekapYear} onChange={e => setRekapYear(e.target.value)} className="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none border border-transparent focus:border-blue-100 transition-all">
                                            {years.map(y => <option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={exportToExcel} className="bg-green-600 text-white px-5 py-3 rounded-2xl text-xs font-black flex items-center gap-2 hover:bg-green-700 shadow-lg shadow-green-100 active:scale-95 transition-all"><i data-lucide="file-spreadsheet" style={{width:16}}></i> EXCEL</button>
                                        <button onClick={() => window.print()} className="bg-slate-800 text-white px-5 py-3 rounded-2xl text-xs font-black flex items-center gap-2 hover:bg-black shadow-lg shadow-slate-100 active:scale-95 transition-all"><i data-lucide="printer" style={{width:16}}></i> CETAK</button>
                                    </div>
                                </div>
                                {selectedClassId && (
                                    <div className="bg-white p-10 rounded-3xl border border-slate-100 shadow-sm overflow-x-auto">
                                        <div className="print-only text-center mb-12 border-b-2 border-slate-800 pb-6">
                                            <h1 className="text-3xl font-black uppercase tracking-tighter mb-1">Laporan Rekapitulasi Presensi</h1>
                                            <p className="font-bold text-slate-600 tracking-widest uppercase text-sm">Kelas: {classes.find(c => c.id === selectedClassId)?.name} â€¢ Periode: {months[rekapMonth]} {rekapYear}</p>
                                        </div>
                                        <table className="w-full text-xs border-collapse rounded-xl overflow-hidden">
                                            <thead>
                                                <tr className="bg-slate-800 text-white">
                                                    <th className="p-4 text-left font-black uppercase tracking-wider">Nama Lengkap Siswa</th>
                                                    <th className="p-4 text-center bg-orange-600 w-12 font-black">S</th>
                                                    <th className="p-4 text-center bg-blue-600 w-12 font-black">I</th>
                                                    <th className="p-4 text-center bg-red-600 w-12 font-black">A</th>
                                                    <th className="p-4 text-center bg-green-600 w-24 font-black">HADIR</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {classes.find(c => c.id === selectedClassId)?.students.map(s => {
                                                    let sCount = 0, iCount = 0, aCount = 0, hCount = 0;
                                                    attendanceRecords
                                                        .filter(r => r.classId === selectedClassId && new Date(r.date).getMonth() === parseInt(rekapMonth) && new Date(r.date).getFullYear() === parseInt(rekapYear))
                                                        .forEach(r => {
                                                            const stat = r.status?.[s.id];
                                                            if(stat === 'S') sCount++; else if(stat === 'I') iCount++; else if(stat === 'A') aCount++; else hCount++;
                                                        });
                                                    return (
                                                        <tr key={s.id} className="border-b hover:bg-slate-50 transition-colors">
                                                            <td className="p-4 font-bold text-slate-700">{s.name}</td>
                                                            <td className="p-4 text-center text-orange-600 font-black bg-orange-50/30">{sCount || '-'}</td>
                                                            <td className="p-4 text-center text-blue-600 font-black bg-blue-50/30">{iCount || '-'}</td>
                                                            <td className="p-4 text-center text-red-600 font-black bg-red-50/30">{aCount || '-'}</td>
                                                            <td className="p-4 text-center text-green-600 font-black bg-green-50/30">{hCount || '-'}</td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                        <div className="print-only mt-16 grid grid-cols-2 text-center text-sm">
                                            <div className="space-y-20">
                                                <p className="font-bold">Kepala Madrasah,</p>
                                                <p className="font-black underline uppercase">........................................</p>
                                            </div>
                                            <div className="space-y-20">
                                                <p className="font-bold">Guru Mata Pelajaran,</p>
                                                <p className="font-black underline uppercase">{user.displayName || '........................................'}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
