<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Digital Madrasah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } @page { size: landscape; margin: 1cm; } }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase Modules from CDN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAlXDVBSJryVlGwtZWYL_BNnh6-7R-SbXk",
            authDomain: "jurnal-guru-f06df.firebaseapp.com",
            projectId: "jurnal-guru-f06df",
            storageBucket: "jurnal-guru-f06df.firebasestorage.app",
            messagingSenderId: "782875410114",
            appId: "1:782875410114:web:67ad0f9c79b35fcc16055b",
            measurementId: "G-FTFKJGVFM1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = 'presensi-madrasah-pro';

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('input-siswa');
            const [classes, setClasses] = useState([]); 
            const [attendanceRecords, setAttendanceRecords] = useState([]); 
            const [loading, setLoading] = useState(true);
            
            // UI States
            const [newClassName, setNewClassName] = useState('');
            const [newStudentName, setNewStudentName] = useState('');
            const [selectedClassId, setSelectedClassId] = useState('');
            const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
            const [rekapMonth, setRekapMonth] = useState(new Date().getMonth());
            const [rekapYear, setRekapYear] = useState(new Date().getFullYear());

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    setClasses([]);
                    setAttendanceRecords([]);
                    return;
                }

                const qClasses = collection(db, 'artifacts', appId, 'users', user.uid, 'classes');
                const unsubClasses = onSnapshot(qClasses, (snapshot) => {
                    setClasses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const qAttendance = collection(db, 'artifacts', appId, 'users', user.uid, 'attendance');
                const unsubAttend = onSnapshot(qAttendance, (snapshot) => {
                    setAttendanceRecords(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubClasses(); unsubAttend(); };
            }, [user]);

            const handleLogin = async () => {
                try { await signInWithPopup(auth, googleProvider); } 
                catch (err) { console.error("Login failed", err); }
            };

            const handleLogout = () => signOut(auth);

            const addClass = async () => {
                if (!newClassName.trim() || !user) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'classes'), {
                    name: newClassName, students: [], createdAt: new Date().toISOString()
                });
                setNewClassName('');
            };

            const addStudent = async (classId) => {
                if (!newStudentName.trim() || !user) return;
                const target = classes.find(c => c.id === classId);
                const updated = [...target.students, { id: Date.now().toString(), name: newStudentName }].sort((a,b) => a.name.localeCompare(b.name));
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'classes', classId), { students: updated });
                setNewStudentName('');
            };

            const saveAttendance = async (classId, date, status) => {
                if (!user) return;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'attendance', `${classId}-${date}`), {
                    date, classId, status, updatedAt: new Date().toISOString()
                });
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;

            if (!user) return (
                <div className="h-screen flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl text-center border">
                        <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-blue-600">
                            <i data-lucide="clipboard-check" style={{width: 32, height: 32}}></i>
                        </div>
                        <h1 className="text-2xl font-black mb-2">Presensi Digital</h1>
                        <p className="text-slate-500 mb-8 text-sm">Masuk dengan akun Google untuk sinkronisasi data antar perangkat.</p>
                        <button onClick={handleLogin} className="w-full flex items-center justify-center gap-3 bg-white border p-3 rounded-xl font-bold hover:bg-slate-50 transition-all shadow-sm">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa_google_main_logo.svg" className="w-5" />
                            Lanjutkan dengan Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 print:p-0">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-8 flex flex-col md:flex-row items-center justify-between gap-4 no-print">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="check-square"></i></div>
                                <div>
                                    <h1 className="text-lg font-black uppercase">Presensi Madrasah</h1>
                                    <p className="text-[10px] text-slate-400 font-bold">{user.email}</p>
                                </div>
                            </div>
                            <div className="flex bg-white p-1 rounded-xl shadow-sm border items-center">
                                <button onClick={() => setActiveTab('input-siswa')} className={`px-4 py-2 rounded-lg text-xs font-bold ${activeTab === 'input-siswa' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Siswa</button>
                                <button onClick={() => setActiveTab('input-hadir')} className={`px-4 py-2 rounded-lg text-xs font-bold ${activeTab === 'input-hadir' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Absen</button>
                                <button onClick={() => setActiveTab('rekap')} className={`px-4 py-2 rounded-lg text-xs font-bold ${activeTab === 'rekap' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Rekap</button>
                                <button onClick={handleLogout} className="px-3 text-slate-300 hover:text-red-500"><i data-lucide="log-out" style={{width:18}}></i></button>
                            </div>
                        </header>

                        {activeTab === 'input-siswa' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-2xl border shadow-sm">
                                    <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><i data-lucide="plus-circle" style={{width:18}}></i> Tambah Kelas</h3>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Nama Kelas (Contoh: 7-A)" value={newClassName} onChange={e => setNewClassName(e.target.value)} className="flex-1 p-3 bg-slate-50 rounded-xl outline-none" />
                                        <button onClick={addClass} className="bg-blue-600 text-white px-6 rounded-xl font-bold">Simpan</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {classes.map(cls => (
                                        <div key={cls.id} className="bg-white rounded-2xl border shadow-sm overflow-hidden flex flex-col">
                                            <div className="bg-slate-50 p-4 border-b flex justify-between items-center">
                                                <span className="font-black text-slate-700 uppercase">{cls.name}</span>
                                                <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'classes', cls.id))} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" style={{width:16}}></i></button>
                                            </div>
                                            <div className="p-4 flex-1 max-h-48 overflow-y-auto custom-scrollbar">
                                                {cls.students.map((s, i) => (
                                                    <div key={s.id} className="flex text-sm py-1 border-b border-slate-50 last:border-0 font-medium text-slate-600">
                                                        <span className="w-6 text-slate-300">{i+1}</span> {s.name}
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-4 border-t flex gap-2">
                                                <input type="text" placeholder="Nama Siswa" value={selectedClassId === cls.id ? newStudentName : ''} onChange={e => {setSelectedClassId(cls.id); setNewStudentName(e.target.value)}} className="flex-1 text-xs p-2 bg-slate-50 rounded-lg outline-none" />
                                                <button onClick={() => addStudent(cls.id)} className="bg-slate-800 text-white p-2 rounded-lg"><i data-lucide="plus" style={{width:16}}></i></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'input-hadir' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-6 rounded-2xl border shadow-sm">
                                    <input type="date" value={attendanceDate} onChange={e => setAttendanceDate(e.target.value)} className="p-3 bg-slate-50 rounded-xl outline-none font-bold" />
                                    <select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="p-3 bg-slate-50 rounded-xl outline-none font-bold">
                                        <option value="">-- Pilih Kelas --</option>
                                        {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>
                                {selectedClassId && (
                                    <div className="bg-white rounded-2xl border shadow-sm overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400">
                                                <tr><th className="p-4">Nama Siswa</th><th className="p-4 text-center">Status (S/I/A)</th></tr>
                                            </thead>
                                            <tbody>
                                                {classes.find(c => c.id === selectedClassId)?.students.map(s => {
                                                    const record = attendanceRecords.find(r => r.id === `${selectedClassId}-${attendanceDate}`);
                                                    const status = record?.status?.[s.id];
                                                    return (
                                                        <tr key={s.id} className="border-b last:border-0">
                                                            <td className="p-4 font-bold text-slate-700">{s.name}</td>
                                                            <td className="p-4">
                                                                <div className="flex justify-center gap-2">
                                                                    {['S', 'I', 'A'].map(v => (
                                                                        <button key={v} onClick={() => {
                                                                            const newStatus = {...(record?.status || {}), [s.id]: status === v ? null : v};
                                                                            saveAttendance(selectedClassId, attendanceDate, newStatus);
                                                                        }} className={`w-8 h-8 rounded-lg font-black border-2 transition-all ${status === v ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-100 text-slate-300'}`}>{v}</button>
                                                                    ))}
                                                                    {!status && <span className="text-[10px] text-green-500 font-black self-center ml-2">HADIR</span>}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'rekap' && (
                            <div className="space-y-4">
                                <div className="flex flex-wrap gap-4 items-center bg-white p-4 rounded-2xl border shadow-sm no-print">
                                    <select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="p-2 bg-slate-50 rounded-lg font-bold text-xs">
                                        <option value="">-- Pilih Kelas --</option>
                                        {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                    <button onClick={() => window.print()} className="ml-auto bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2"><i data-lucide="printer" style={{width:16}}></i> Cetak PDF</button>
                                </div>
                                {selectedClassId && (
                                    <div className="bg-white p-8 rounded-2xl border shadow-sm overflow-x-auto">
                                        <div className="print-only text-center mb-8">
                                            <h1 className="text-xl font-black uppercase">Rekapitulasi Presensi Bulanan</h1>
                                            <p className="font-bold">Kelas: {classes.find(c => c.id === selectedClassId)?.name}</p>
                                        </div>
                                        <table className="w-full text-xs border-collapse">
                                            <thead>
                                                <tr>
                                                    <th className="border p-2 text-left bg-slate-50">Nama Siswa</th>
                                                    <th className="border p-2 text-center bg-orange-50 w-8">S</th>
                                                    <th className="border p-2 text-center bg-blue-50 w-8">I</th>
                                                    <th className="border p-2 text-center bg-red-50 w-8">A</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {classes.find(c => c.id === selectedClassId)?.students.map(s => {
                                                    let sCount = 0, iCount = 0, aCount = 0;
                                                    attendanceRecords.filter(r => r.classId === selectedClassId).forEach(r => {
                                                        const stat = r.status?.[s.id];
                                                        if(stat === 'S') sCount++; else if(stat === 'I') iCount++; else if(stat === 'A') aCount++;
                                                    });
                                                    return (
                                                        <tr key={s.id}>
                                                            <td className="border p-2 font-bold">{s.name}</td>
                                                            <td className="border p-2 text-center text-orange-600 font-bold">{sCount || '-'}</td>
                                                            <td className="border p-2 text-center text-blue-600 font-bold">{iCount || '-'}</td>
                                                            <td className="border p-2 text-center text-red-600 font-bold">{aCount || '-'}</td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Refresh icons after render
        setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 1000);
    </script>
</body>
</html>
